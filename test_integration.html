<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TinkerProfiles Integration Test</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Test navbar similar to base template -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/">
                <i class="fas fa-tools me-2"></i>TinkerTools
            </a>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Test Link</a>
                    </li>
                </ul>
                
                <ul class="navbar-nav">
                    <!-- TinkerProfiles selector will be injected here -->
                    <li class="nav-item">
                        <span class="navbar-text">
                            <small class="text-muted me-2">Current time on Rubi-Ka:</small>
                            <span id="rk-clock"></span>
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>TinkerProfiles Integration Test</h1>
        <p>This page tests the TinkerProfiles integration with the base template.</p>
        
        <div class="row">
            <div class="col-md-6">
                <h3>Profile System Status</h3>
                <div id="status-info">
                    <p>Loading...</p>
                </div>
            </div>
            <div class="col-md-6">
                <h3>Test Actions</h3>
                <button class="btn btn-primary me-2" onclick="testCreateProfile()">Create Test Profile</button>
                <button class="btn btn-secondary me-2" onclick="testGetActiveProfile()">Get Active Profile</button>
                <button class="btn btn-info" onclick="testProfileList()">List All Profiles</button>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h3>Profile Information</h3>
                <pre id="profile-info" class="bg-light p-3 rounded">No profile data available</pre>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- TinkerProfiles -->
    <script src="static/js/tinker-profiles.js"></script>
    <script src="static/js/tinker-profiles-ui.js"></script>
    
    <!-- Initialize TinkerToolsUtils from base template pattern -->
    <script>
    // Ensure TinkerToolsUtils is available for tests
    if (typeof window.TinkerToolsUtils === 'undefined') {
        window.TinkerToolsUtils = {
            getActiveProfile: function() {
                return TinkerProfiles.getActiveProfile();
            },
            setActiveProfile: function(profileId) {
                return TinkerProfiles.setActiveProfile(profileId);
            },
            getAppData: function(appName) {
                const profile = TinkerProfiles.getActiveProfile();
                return profile && profile.appData ? profile.appData[appName] : null;
            },
            setAppData: function(appName, data) {
                const profile = TinkerProfiles.getActiveProfile();
                if (profile) {
                    if (!profile.appData) profile.appData = {};
                    profile.appData[appName] = data;
                    TinkerProfiles.updateProfile(profile.id, profile);
                }
            }
        };
    }
    </script>

    <script>
        // Test functions
        function updateStatus() {
            const statusDiv = document.getElementById('status-info');
            const profileInfoPre = document.getElementById('profile-info');
            
            if (typeof TinkerProfiles !== 'undefined') {
                const activeProfile = TinkerProfiles.getActiveProfile();
                const profileList = TinkerProfiles.getProfileList();
                
                statusDiv.innerHTML = `
                    <p><strong>TinkerProfiles:</strong> ✅ Loaded</p>
                    <p><strong>Active Profile:</strong> ${activeProfile ? activeProfile.character.name : 'None'}</p>
                    <p><strong>Total Profiles:</strong> ${profileList.length}</p>
                `;
                
                if (activeProfile) {
                    profileInfoPre.textContent = JSON.stringify(activeProfile, null, 2);
                }
            } else {
                statusDiv.innerHTML = '<p><strong>TinkerProfiles:</strong> ❌ Not loaded</p>';
            }
        }
        
        function testCreateProfile() {
            if (typeof TinkerProfiles === 'undefined') {
                alert('TinkerProfiles not loaded');
                return;
            }
            
            try {
                const profileId = TinkerProfiles.createProfile({
                    character: {
                        name: 'TestChar' + Date.now().toString().slice(-4),
                        profession: 'Agent',
                        level: 220,
                        faction: 'Neutral',
                        accountType: 'Paid'
                    }
                });
                
                TinkerProfiles.setActiveProfile(profileId);
                updateStatus();
                alert('Test profile created successfully!');
            } catch (error) {
                alert('Error creating profile: ' + error.message);
            }
        }
        
        function testGetActiveProfile() {
            if (typeof TinkerProfiles === 'undefined') {
                alert('TinkerProfiles not loaded');
                return;
            }
            
            const profile = TinkerProfiles.getActiveProfile();
            alert(profile ? 
                `Active Profile: ${profile.character.name} (${profile.character.profession})` : 
                'No active profile'
            );
        }
        
        function testProfileList() {
            if (typeof TinkerProfiles === 'undefined') {
                alert('TinkerProfiles not loaded');
                return;
            }
            
            const profiles = TinkerProfiles.getProfileList();
            const profileNames = profiles.map(p => `${p.name} (${p.profession})`).join('\n');
            alert(profiles.length > 0 ? 
                `Profiles:\n${profileNames}` : 
                'No profiles found'
            );
        }
        
        // RK Clock (from base template)
        function updateRKClock() {
            var rk_date = new Date();
            rk_date.setFullYear(rk_date.getFullYear() + 27474);
            var timeString = rk_date.toUTCString().slice(0, -4);
            
            var clockNav = document.getElementById('rk-clock');
            if (clockNav) clockNav.textContent = timeString;
        }
        
        updateRKClock();
        setInterval(updateRKClock, 1000);
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(updateStatus, 500); // Wait for TinkerProfiles to initialize
            
            // Listen for profile changes
            document.addEventListener('profileChanged', function(event) {
                console.log('Profile changed event received:', event.detail);
                updateStatus();
            });
        });
    </script>
</body>
</html>